# CI Scripts

–í –∫–∞—Ç–∞–ª–æ–≥–µ —Å–æ–±—Ä–∞–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏–ª–∏ –≤ GitHub Actions workflow –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ø–µ—Ä–µ–¥ Terraform.

> **üìã –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CI/CD**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ [SECRETS.md](SECRETS.md)

> **üìù GitHub Actions workflow**: –§–∞–π–ª `.github/workflows/ci.yml` —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ CI/CD –ø–∞–π–ø–ª–∞–π–Ω–∞.

> **üîß –ü—Ä–æ–±–ª–µ–º—ã?**: –°–º. [TROUBLESHOOTING.md](TROUBLESHOOTING.md) –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º.

## `build_backend.sh`

–°–æ–±–∏—Ä–∞–µ—Ç backend-–æ–±—Ä–∞–∑ –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –µ–≥–æ –≤ Yandex Container Registry.

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ):

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è        | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------------------|----------|
| `REGISTRY_ID`     | ID Container Registry (–Ω–∞–ø—Ä–∏–º–µ—Ä, `crp50gpc30l3tbd4rtj0`). |
| `IMAGE_TAG`       | –¢–µ–≥ –æ–±—Ä–∞–∑–∞ (`latest`, `dev`, `$CI_COMMIT_SHORT_SHA`). |
| `YC_OAUTH_TOKEN`  | OAuth/IAM —Ç–æ–∫–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ `yc iam create-token`. |

–ü—Ä–∏–º–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:

```bash
export REGISTRY_ID=crp50gpc30l3tbd4rtj0
export IMAGE_TAG=dev
export YC_OAUTH_TOKEN=$(yc iam create-token)
./CI/build_backend.sh
```

–í GitHub Actions workflow –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç—ã (`REGISTRY_ID`, `YC_OAUTH_TOKEN`). `IMAGE_TAG` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `${{ github.sha }}` (–ø–æ–ª–Ω—ã–π —Ö–µ—à –∫–æ–º–º–∏—Ç–∞).

## `build_frontend.sh`

–°–æ–±–∏—Ä–∞–µ—Ç React/Vite —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –≤—ã–≥—Ä—É–∂–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π `dist/` –≤ Object Storage (Yandex S3).

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ):

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è              | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------------------------|----------|
| `STATIC_BUCKET_NAME`    | –ò–º—è –±–∞–∫–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `kulibin-devops-portfolio`). |
| `API_GATEWAY_ENDPOINT`  | URL API Gateway, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ `VITE_API_BASE_URL`. |
| `AWS_ACCESS_KEY_ID`     | Access key –¥–ª—è Object Storage (–∏–∑ Terraform output). |
| `AWS_SECRET_ACCESS_KEY` | Secret key –¥–ª—è Object Storage (–∏–∑ Terraform output). |

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞:

```bash
export STATIC_BUCKET_NAME=kulibin-devops-portfolio
export API_GATEWAY_ENDPOINT=https://d5dm4d9170q82do7f5m8.lievo6ut.apigw.yandexcloud.net
export AWS_ACCESS_KEY_ID=$(terraform -chdir=terraform/serverless output -raw static_site_access_key)
export AWS_SECRET_ACCESS_KEY=$(terraform -chdir=terraform/serverless output -raw static_site_secret_key)
./CI/build_frontend.sh
```

–í GitHub Actions workflow –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (`STATIC_BUCKET_NAME`, `API_GATEWAY_ENDPOINT`, `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ Terraform outputs. –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç `npm ci`, `npm run build` –∏ `yc storage s3 cp --recursive dist/ ...`.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub Actions workflow –±–µ–∑ –¥–µ–ø–ª–æ—è

–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `.github/workflows/ci.yml` –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –¥–æ –ø—É—à–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤:

### 1. –õ–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–Ω—Ç–µ—Ä `actionlint`

`actionlint` ‚Äî –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ª–∏–Ω—Ç–µ—Ä GitHub Actions workflow: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å YAML, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π, `uses`, `needs`, shell-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –ø—Ä.

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (Arch Linux)

```bash
sudo pacman -S actionlint
```

–ò–õ–ò —Å–∫–∞—á–∞–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑:

```bash
curl -L https://github.com/rhysd/actionlint/releases/latest/download/actionlint_$(uname -s)_$(uname -m).tar.gz \
  | tar -xz -C /tmp
sudo mv /tmp/actionlint /usr/local/bin/
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ workflow

```bash
actionlint .github/workflows/ci.yml
```

- –µ—Å–ª–∏ —Ñ–∞–π–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –±–µ–∑ –≤—ã–≤–æ–¥–∞;
- –æ—à–∏–±–∫–∏ –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–æ–∫—É –∏ –ø–æ–¥—Å–∫–∞–∑–∫—É, –∫–∞–∫—É—é —á–∞—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –Ω—É–∂–Ω–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å;
- —É–¥–æ–±–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ pre-commit –∏–ª–∏ CI (–Ω–∞–ø—Ä–∏–º–µ—Ä, `actionlint $(git ls-files '*.yml')`).

### 2. `act` + –ø–æ–¥–º–µ–Ω–∞ ‚Äú–æ–ø–∞—Å–Ω—ã—Ö‚Äù —à–∞–≥–æ–≤

[`nektos/act`](https://github.com/nektos/act) –∑–∞–ø—É—Å–∫–∞–µ—Ç workflow –ª–æ–∫–∞–ª—å–Ω–æ –≤ Docker, –ø–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–∞–π–ø–ª–∞–π–Ω–∞ –±–µ–∑ –∫–æ–º–º–∏—Ç–∞. –ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `act` (–≤ Arch Linux: `yay -S act` –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ –±–∏–Ω–∞—Ä–Ω–∏–∫ —Å GitHub Releases).
2. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ mock-—Å–µ–∫—Ä–µ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.secrets` —Å `YC_IAM_TOKEN=dummy` –∏ –¥—Ä.).
3. –í `.github/workflows/ci.yml` –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–Ω–∏—Ç–µ —à–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞—é—Ç/—É–¥–∞–ª—è—é—Ç —Ä–µ—Å—É—Ä—Å—ã (Terraform Apply, —É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ —Ç.–ø.), –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏:

```yaml
- name: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Terraform
  run: echo "Skipped in local act run"
```

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–∞–π–ø–ª–∞–π–Ω:

```bash
act push -W .github/workflows/ci.yml
```

–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —à–∞–≥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø—Ä–∏ —ç—Ç–æ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ Yandex Cloud –Ω–µ –∑–∞–¥–µ–π—Å—Ç–≤—É–µ—Ç—Å—è.

### –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
–í–æ–∑–º–æ–∂–µ–Ω –ø—Ä–æ–≥–æ–Ω –Ω–∞ self-hosted runner, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GitHub CLI `gh workflow run`, –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã REST API, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –±–æ–ª–µ–µ ‚Äú–±–æ–µ–≤–æ–π‚Äù —Å—Ü–µ–Ω–∞—Ä–∏–π, –Ω–æ –æ–Ω–∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç –º–æ—â–Ω–æ—Å—Ç–µ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã.

**–°–æ–≤–µ—Ç:** –ø–µ—Ä–µ–¥ –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤—å—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã/—Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–µ—Å–æ—á–Ω–∏—Ü—ã –∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —à–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥-–æ–∫—Ä—É–∂–µ–Ω–∏–µ.

