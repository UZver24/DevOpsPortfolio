name: Serverless Deploy

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      action:
        description: "Choose workflow action"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - destroy

env:
  TFVARS_FILE: terraform/serverless/terraform.tfvars

jobs:
  deploy-serverless:
    name: Bootstrap + Deploy + Frontend Upload
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
          echo "$HOME/yandex-cloud/bin" >> "$GITHUB_PATH"

      - name: Configure yc profile
        env:
          YC_OAUTH_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          yc config profile create ci || true
          if [[ -z "${YC_OAUTH_TOKEN:-}" ]]; then
            echo "YC_OAUTH_TOKEN secret is not set" >&2
            exit 1
          fi
          yc config set token "$YC_OAUTH_TOKEN"
          yc config set cloud-id "$YC_CLOUD_ID"
          yc config set folder-id "$YC_FOLDER_ID"
          YC_IAM_TOKEN="$(yc iam create-token | tr -d '\r\n')"
          if [[ -z "$YC_IAM_TOKEN" ]]; then
            echo "Failed to generate IAM token from YC_OAUTH_TOKEN" >&2
            exit 1
          fi
          echo "::add-mask::$YC_IAM_TOKEN"
          echo "YC_IAM_TOKEN=$YC_IAM_TOKEN" >> "$GITHUB_ENV"

      - name: Generate terraform.tfvars
        env:
          YC_IAM_TOKEN: ${{ env.YC_IAM_TOKEN }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_ZONE: ${{ secrets.YC_ZONE }}
          STATIC_BUCKET_NAME: ${{ secrets.STATIC_BUCKET_NAME }}
        run: |
          cat > "$TFVARS_FILE" <<EOFVARS
          yc_token = "$YC_IAM_TOKEN"
          yc_cloud_id = "$YC_CLOUD_ID"
          yc_folder_id = "$YC_FOLDER_ID"
          yc_zone = "${YC_ZONE:-ru-central1-a}"

          project_name = "devops-portfolio-serverless"
          environment  = "dev"

          container_registry_name = "kulibin-devops-portfolio"
          backend_image_tag = "latest"

          backend_memory_mb   = 256
          backend_cpu         = 0.1
          backend_concurrency = 8
          backend_env         = {}

          frontend_image            = ""
          frontend_memory_mb        = 128
          frontend_cpu              = 0.05
          frontend_concurrency      = 8
          frontend_env              = {}
          enable_frontend_container = false

          static_bucket_name = "${STATIC_BUCKET_NAME}"
          static_allowed_origins = [
            "https://${STATIC_BUCKET_NAME}.website.yandexcloud.net",
          ]
          api_allowed_origins = [
            "https://${STATIC_BUCKET_NAME}.website.yandexcloud.net",
          ]

          create_api_gateway = true
          EOFVARS

      - name: Terraform bootstrap apply
        run: |
          terraform -chdir=terraform/serverless/bootstrap init
          ./scripts/serverless-bootstrap-import.sh
          terraform -chdir=terraform/serverless/bootstrap apply -auto-approve -var-file=../terraform.tfvars

      - name: Build and push backend image
        run: ./scripts/serverless-build-push-backend.sh

      - name: Terraform deploy apply
        run: ./scripts/serverless-deploy-apply.sh

      - name: Build frontend
        run: ./scripts/serverless-build-frontend.sh

      - name: Upload frontend to Object Storage
        run: ./scripts/serverless-upload-frontend.sh

      - name: Print outputs
        run: |
          echo "Bootstrap outputs:"
          terraform -chdir=terraform/serverless/bootstrap output
          echo "Deploy outputs:"
          terraform -chdir=terraform/serverless/deploy output

  destroy-serverless:
    name: Destroy Serverless Infrastructure
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
          echo "$HOME/yandex-cloud/bin" >> "$GITHUB_PATH"

      - name: Configure yc profile
        env:
          YC_OAUTH_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
        run: |
          yc config profile create ci || true
          if [[ -z "${YC_OAUTH_TOKEN:-}" ]]; then
            echo "YC_OAUTH_TOKEN secret is not set" >&2
            exit 1
          fi
          yc config set token "$YC_OAUTH_TOKEN"
          yc config set cloud-id "$YC_CLOUD_ID"
          yc config set folder-id "$YC_FOLDER_ID"
          YC_IAM_TOKEN="$(yc iam create-token | tr -d '\r\n')"
          if [[ -z "$YC_IAM_TOKEN" ]]; then
            echo "Failed to generate IAM token from YC_OAUTH_TOKEN" >&2
            exit 1
          fi
          echo "::add-mask::$YC_IAM_TOKEN"
          echo "YC_IAM_TOKEN=$YC_IAM_TOKEN" >> "$GITHUB_ENV"

      - name: Generate terraform.tfvars
        env:
          YC_IAM_TOKEN: ${{ env.YC_IAM_TOKEN }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_ZONE: ${{ secrets.YC_ZONE }}
          STATIC_BUCKET_NAME: ${{ secrets.STATIC_BUCKET_NAME }}
        run: |
          cat > "$TFVARS_FILE" <<EOFVARS
          yc_token = "$YC_IAM_TOKEN"
          yc_cloud_id = "$YC_CLOUD_ID"
          yc_folder_id = "$YC_FOLDER_ID"
          yc_zone = "${YC_ZONE:-ru-central1-a}"

          project_name = "devops-portfolio-serverless"
          environment  = "dev"

          container_registry_name = "kulibin-devops-portfolio"
          backend_image_tag = "latest"

          backend_memory_mb   = 256
          backend_cpu         = 0.1
          backend_concurrency = 8
          backend_env         = {}

          frontend_image            = ""
          frontend_memory_mb        = 128
          frontend_cpu              = 0.05
          frontend_concurrency      = 8
          frontend_env              = {}
          enable_frontend_container = false

          static_bucket_name = "${STATIC_BUCKET_NAME}"
          static_allowed_origins = [
            "https://${STATIC_BUCKET_NAME}.website.yandexcloud.net",
          ]
          api_allowed_origins = [
            "https://${STATIC_BUCKET_NAME}.website.yandexcloud.net",
          ]

          create_api_gateway = true
          EOFVARS

      - name: Destroy infrastructure
        run: ./scripts/serverless-destroy-all.sh
