name: CI/CD Pipeline

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-backend:
    name: Build and Push Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify secrets are set
        run: |
          if [ -z "${{ secrets.YC_IAM_TOKEN }}" ]; then
            echo "âŒ ERROR: YC_IAM_TOKEN secret is not set or empty"
            exit 1
          fi
          if [ -z "${{ secrets.REGISTRY_ID }}" ]; then
            echo "âŒ ERROR: REGISTRY_ID secret is not set or empty"
            exit 1
          fi
          echo "âœ… Secrets are set"
          echo "Registry: cr.yandex"
          echo "Registry ID: ${{ secrets.REGISTRY_ID }}"

      - name: Login to Yandex Container Registry
        run: |
          echo "${{ secrets.YC_IAM_TOKEN }}" | \
            docker login --username iam --password-stdin cr.yandex

      - name: Build and push backend image
        env:
          REGISTRY_ID: ${{ secrets.REGISTRY_ID }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          YC_IAM_TOKEN: ${{ secrets.YC_IAM_TOKEN }}
        run: |
          cd CI
          chmod +x build_backend.sh
          ./build_backend.sh

  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Check for existing API Gateway
        working-directory: infrastructure/serverless
        env:
          YC_TOKEN: ${{ secrets.YC_IAM_TOKEN }}
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ yc CLI Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash >/dev/null 2>&1 || true
          export PATH="$PATH:$HOME/yandex-cloud/bin"
          
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
          export YC_TOKEN="$YC_TOKEN"
          export YC_FOLDER_ID="${{ secrets.YC_FOLDER_ID }}"
          export YC_CLOUD_ID="${{ secrets.YC_CLOUD_ID }}"
          yc config set token "$YC_TOKEN" >/dev/null 2>&1 || true
          yc config set folder-id "${{ secrets.YC_FOLDER_ID }}" >/dev/null 2>&1 || true
          yc config set cloud-id "${{ secrets.YC_CLOUD_ID }}" >/dev/null 2>&1 || true
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ API Gateway
          API_GATEWAY_NAME="devops-portfolio-serverless-api"
          if yc serverless api-gateway get --name "$API_GATEWAY_NAME" --format json >/dev/null 2>&1; then
            echo "API_GATEWAY_EXISTS=true" >> $GITHUB_ENV
            echo "â„¹ï¸  API Gateway '$API_GATEWAY_NAME' already exists - will not create (Terraform import not supported)"
            echo "TODO: Ð¢Ð Ð•Ð‘Ð£Ð•Ð¢Ð¡Ð¯ ÐŸÐ ÐÐ’ÐšÐ - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼ API Gateway"
          else
            # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ yc auth failed - Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ (ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Terraform Ð²Ñ‹Ð´Ð°ÑÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÑƒ)
            echo "API_GATEWAY_EXISTS=false" >> $GITHUB_ENV
            echo "âœ“ API Gateway '$API_GATEWAY_NAME' not found (or yc auth failed) - will attempt to create"
          fi

      - name: Create terraform.tfvars
        working-directory: infrastructure/serverless
        env:
          API_GATEWAY_EXISTS: ${{ env.API_GATEWAY_EXISTS }}
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ create_api_gateway Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
          if [ "$API_GATEWAY_EXISTS" = "true" ]; then
            CREATE_API_GATEWAY="false"
          else
            CREATE_API_GATEWAY="true"
          fi
          
          cat > terraform.tfvars <<EOF
          yc_token = "${{ secrets.YC_IAM_TOKEN }}"
          yc_cloud_id = "${{ secrets.YC_CLOUD_ID }}"
          yc_folder_id = "${{ secrets.YC_FOLDER_ID }}"
          yc_zone = "${{ secrets.YC_ZONE }}"
          
          backend_image = "cr.yandex/${{ secrets.REGISTRY_ID }}/backend:${{ env.IMAGE_TAG }}"
          frontend_image = "cr.yandex/${{ secrets.REGISTRY_ID }}/frontend:latest"
          
          container_registry_id = "${{ secrets.REGISTRY_ID }}"
          
          static_bucket_name = "${{ secrets.STATIC_BUCKET_NAME }}"
          static_allowed_origins = [
            "https://${{ secrets.STATIC_BUCKET_NAME }}.website.yandexcloud.net",
          ]
          api_allowed_origins = [
            "https://${{ secrets.STATIC_BUCKET_NAME }}.website.yandexcloud.net",
            "http://localhost:3000",
            "http://localhost:5173",
          ]
          
          # TODO: Ð¢Ð Ð•Ð‘Ð£Ð•Ð¢Ð¡Ð¯ ÐŸÐ ÐÐ’ÐšÐ - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ API Gateway
          create_api_gateway = $CREATE_API_GATEWAY
          EOF

      - name: Terraform Init
        working-directory: infrastructure/serverless
        env:
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ IAM Ñ‚Ð¾ÐºÐµÐ½ Ð´Ð»Ñ terraform
          YC_TOKEN: ${{ secrets.YC_IAM_TOKEN }}
        run: terraform init

      - name: Delete existing service accounts (if any)
        working-directory: infrastructure/serverless
        env:
          YC_TOKEN: ${{ secrets.YC_IAM_TOKEN }}
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ yc CLI
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH="$PATH:$HOME/yandex-cloud/bin"
          
          # ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐµÐ¼ÑÑ Ð² yc Ñ‡ÐµÑ€ÐµÐ· Ñ‚Ð¾ÐºÐµÐ½ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ)
          # yc CLI Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ YC_TOKEN Ð¸Ð· Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          export YC_TOKEN="$YC_TOKEN"
          export YC_FOLDER_ID="${{ secrets.YC_FOLDER_ID }}"
          export YC_CLOUD_ID="${{ secrets.YC_CLOUD_ID }}"
          
          # Ð¢Ð°ÐºÐ¶Ðµ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· config Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸
          yc config set token "$YC_TOKEN" || true
          yc config set folder-id "${{ secrets.YC_FOLDER_ID }}" || true
          yc config set cloud-id "${{ secrets.YC_CLOUD_ID }}" || true
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
          echo "Testing yc authentication..."
          if yc iam service-account list --format json >/dev/null 2>&1; then
            echo "âœ“ yc authentication successful"
          else
            echo "âœ— yc authentication failed - trying alternative method..."
            # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
            YC_TOKEN="$YC_TOKEN" yc iam service-account list --format json >/dev/null 2>&1 && echo "âœ“ yc authentication successful (via env var)" || echo "âœ— yc authentication still failed"
          fi
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ project_name Ð¸Ð· terraform.tfvars Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´ÐµÑ„Ð¾Ð»Ñ‚
          PROJECT_NAME=$(grep -E '^project_name\s*=' terraform.tfvars 2>/dev/null | sed 's/.*= *"\(.*\)".*/\1/' || echo "")
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="devops-portfolio-serverless"
          fi
          
          echo "Using project_name: '$PROJECT_NAME'"
          
          # Ð˜Ð¼ÐµÐ½Ð° ÑÐµÑ€Ð²Ð¸ÑÐ½Ñ‹Ñ… Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð¾Ð²
          SERVERLESS_SA_NAME="${PROJECT_NAME}-serverless-sa"
          STATIC_SITE_SA_NAME="${PROJECT_NAME}-static-site"
          
          echo "Checking for existing service accounts: '$SERVERLESS_SA_NAME' and '$STATIC_SITE_SA_NAME'"
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¸ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸
          SERVERLESS_SA_ID=$(yc iam service-account get --name "$SERVERLESS_SA_NAME" --format json 2>/dev/null | jq -r '.id // empty' || echo "")
          if [ -n "$SERVERLESS_SA_ID" ]; then
            echo "Deleting existing service account: $SERVERLESS_SA_NAME ($SERVERLESS_SA_ID)"
            yc iam service-account delete --id "$SERVERLESS_SA_ID" --format json 2>&1 || echo "Failed to delete or already deleted"
          else
            echo "Service account $SERVERLESS_SA_NAME not found by name"
          fi
          
          STATIC_SITE_SA_ID=$(yc iam service-account get --name "$STATIC_SITE_SA_NAME" --format json 2>/dev/null | jq -r '.id // empty' || echo "")
          if [ -n "$STATIC_SITE_SA_ID" ]; then
            echo "Deleting existing service account: $STATIC_SITE_SA_NAME ($STATIC_SITE_SA_ID)"
            yc iam service-account delete --id "$STATIC_SITE_SA_ID" --format json 2>&1 || echo "Failed to delete or already deleted"
          else
            echo "Service account $STATIC_SITE_SA_NAME not found by name"
          fi
          
          # ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð¾ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾ Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ ID (Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸)
          echo "Attempting to delete service accounts by known IDs..."
          for known_id in "ajebh4qukejfcj3vurm1" "aje6eo39svoevpsmv61o"; do
            echo "Checking if service account $known_id exists..."
            if yc iam service-account get --id "$known_id" --format json >/dev/null 2>&1; then
              echo "Found service account $known_id, deleting..."
              yc iam service-account delete --id "$known_id" --format json 2>&1 && echo "Successfully deleted $known_id" || echo "Failed to delete $known_id (may have dependencies)"
            else
              echo "Service account $known_id not found (already deleted or doesn't exist)"
            fi
          done
          
          echo "Cleanup completed. Attempting to import known service accounts into Terraform state..."
          echo "This prevents 'AlreadyExists' errors if the accounts still exist."
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ½Ñ‹Ðµ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ñ‹ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· Terraform
          # Terraform ÑÐ°Ð¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð»Ð¸Ð±Ð¾ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚, Ð»Ð¸Ð±Ð¾ Ð¿Ñ€Ð¾Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
          SERVERLESS_SA_ID="ajebh4qukejfcj3vurm1"
          STATIC_SITE_SA_ID="aje6eo39svoevpsmv61o"
          
          # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ serverless SA (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ - ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ Ð² state Ð¸Ð»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾)
          echo "ðŸ“¥ Attempting to import serverless service account ($SERVERLESS_SA_ID)..."
          if terraform import yandex_iam_service_account.serverless "$SERVERLESS_SA_ID" 2>&1; then
            echo "  âœ“ Successfully imported serverless service account"
          else
            echo "  â„¹ï¸  Import skipped (resource may not exist, already in state, or name mismatch - this is OK)"
          fi
          
          # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ static_site SA
          echo "ðŸ“¥ Attempting to import static_site service account ($STATIC_SITE_SA_ID)..."
          if terraform import yandex_iam_service_account.static_site "$STATIC_SITE_SA_ID" 2>&1; then
            echo "  âœ“ Successfully imported static_site service account"
          else
            echo "  â„¹ï¸  Import skipped (resource may not exist, already in state, or name mismatch - this is OK)"
          fi
          
          echo "âœ… Service account import attempt completed"
          
          # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹
          echo ""
          echo "Attempting to import other existing resources..."
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ð±Ð°ÐºÐµÑ‚Ð° Ð¸Ð· terraform.tfvars
          BUCKET_NAME=$(grep -E '^static_bucket_name\s*=' terraform.tfvars 2>/dev/null | sed 's/.*= *"\(.*\)".*/\1/' || echo "")
          if [ -n "$BUCKET_NAME" ]; then
            echo "ðŸ“¥ Attempting to import storage bucket ($BUCKET_NAME)..."
            if terraform import yandex_storage_bucket.static_site "$BUCKET_NAME" 2>&1; then
              echo "  âœ“ Successfully imported storage bucket"
            else
              echo "  â„¹ï¸  Import skipped (bucket may not exist, already in state, or name mismatch - this is OK)"
            fi
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑƒÐ¶Ðµ Ð² state
          echo "Checking current Terraform state..."
          terraform state list 2>/dev/null || echo "  (No state file yet)"
          
          # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ serverless container (Ð½ÑƒÐ¶ÐµÐ½ ID, Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· data source)
          CONTAINER_NAME="devops-portfolio-serverless-backend"
          echo "ðŸ“¥ Attempting to import serverless container ($CONTAINER_NAME)..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ data source Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ID ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
          cat > container_import.tf <<'EOF'
          data "yandex_serverless_container" "existing_backend" {
            name = "devops-portfolio-serverless-backend"
          }
          
          output "container_id" {
            value = try(data.yandex_serverless_container.existing_backend.id, "")
          }
          EOF
          
          # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Terraform ÑÐ½Ð¾Ð²Ð° Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ data source
          terraform init -upgrade >/dev/null 2>&1 || true
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ID ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° Ñ‡ÐµÑ€ÐµÐ· terraform apply Ð´Ð»Ñ data source Ð¸ output
          # Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÐµÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½
          terraform apply -auto-approve -target=data.yandex_serverless_container.existing_backend -target=output.container_id >/dev/null 2>&1 || true
          CONTAINER_ID=$(terraform output -raw container_id 2>/dev/null || echo "")
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
          rm -f container_import.tf
          
          if [ -n "$CONTAINER_ID" ] && [ "$CONTAINER_ID" != "null" ] && [ "$CONTAINER_ID" != "" ]; then
            echo "  Found container ID: $CONTAINER_ID"
            if terraform import yandex_serverless_container.backend "$CONTAINER_ID" 2>&1; then
              echo "  âœ“ Successfully imported serverless container"
            else
              echo "  â„¹ï¸  Import failed (container may already be in state or name mismatch)"
            fi
          else
            echo "  â„¹ï¸  Container not found via data source (may not exist or need different approach)"
            echo "  Note: If you see 'Container already exists' error later, container exists but needs manual import with ID"
            
            # Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾
            echo "ðŸ—‘ï¸  Attempting to delete existing serverless container ($CONTAINER_NAME) if it exists..."
            if yc serverless container get --name "$CONTAINER_NAME" --format json >/dev/null 2>&1; then
              CONTAINER_ID_FOR_DELETE=$(yc serverless container get --name "$CONTAINER_NAME" --format json 2>/dev/null | jq -r '.id // empty' || echo "")
              if [ -n "$CONTAINER_ID_FOR_DELETE" ]; then
                echo "  Found container ID: $CONTAINER_ID_FOR_DELETE, deleting..."
                yc serverless container delete --id "$CONTAINER_ID_FOR_DELETE" 2>&1 && echo "  âœ“ Successfully deleted container" || echo "  âœ— Failed to delete container (may have dependencies)"
              fi
            else
              echo "  â„¹ï¸  Container not found (may not exist or yc auth failed)"
            fi
          fi
          if [ -z "$CONTAINER_ID" ] || [ "$CONTAINER_ID" = "null" ] || [ "$CONTAINER_ID" = "" ]; then
            echo "ðŸ—‘ï¸  Attempting to delete existing serverless container ($CONTAINER_NAME) if it exists..."
            if yc serverless container get --name "$CONTAINER_NAME" --format json >/dev/null 2>&1; then
              CONTAINER_ID_FOR_DELETE=$(yc serverless container get --name "$CONTAINER_NAME" --format json 2>/dev/null | jq -r '.id // empty' || echo "")
              if [ -n "$CONTAINER_ID_FOR_DELETE" ]; then
                echo "  Found container ID: $CONTAINER_ID_FOR_DELETE, deleting..."
                yc serverless container delete --id "$CONTAINER_ID_FOR_DELETE" 2>&1 && echo "  âœ“ Successfully deleted container" || echo "  âœ— Failed to delete container (may have dependencies)"
              fi
            else
              echo "  â„¹ï¸  Container not found (may not exist or yc auth failed)"
            fi
          fi

      - name: Terraform Apply
        working-directory: infrastructure/serverless
        env:
          YC_TOKEN: ${{ secrets.YC_IAM_TOKEN }}
          TF_INPUT: "false"
        run: |
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ terraform apply
          set +e  # ÐÐµ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ
          terraform apply -auto-approve 2>&1 | tee /tmp/terraform-apply.log
          APPLY_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ $APPLY_EXIT_CODE -eq 0 ]; then
            echo "âœ“ Terraform apply completed successfully"
          else
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð»Ð° Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° "Duplicate name" Ð´Ð»Ñ API Gateway
            if grep -q "Duplicate name.*devops-portfolio-serverless-api" /tmp/terraform-apply.log || \
               grep -q "yandex_api_gateway.backend.*Duplicate name" /tmp/terraform-apply.log; then
              echo ""
              echo "âš ï¸  API Gateway already exists (Duplicate name error)"
              echo "â„¹ï¸  This is expected - API Gateway exists but Terraform import is not supported"
              echo "â„¹ï¸  Continuing with other resources..."
              echo "TODO: Ð¢Ð Ð•Ð‘Ð£Ð•Ð¢Ð¡Ð¯ ÐŸÐ ÐÐ’ÐšÐ - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ API Gateway"
              echo ""
              
              # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹, Ð¸ÑÐºÐ»ÑŽÑ‡Ð°Ñ API Gateway
              # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ terraform apply Ñ ÑÐ²Ð½Ñ‹Ð¼ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· -target
              echo "Applying resources excluding API Gateway..."
              terraform apply -auto-approve \
                -target=yandex_iam_service_account.serverless \
                -target=yandex_iam_service_account.static_site \
                -target=yandex_iam_service_account_static_access_key.static_site \
                -target=yandex_resourcemanager_folder_iam_member.serverless_admin \
                -target=yandex_resourcemanager_folder_iam_member.cr_puller \
                -target=yandex_resourcemanager_folder_iam_member.static_site_storage_editor \
                -target=yandex_container_registry_iam_binding.registry_puller \
                -target=yandex_serverless_container.backend \
                -target=yandex_serverless_container_iam_binding.backend_public \
                -target=yandex_storage_bucket.static_site 2>&1 || {
                  echo "âš ï¸  Some resources may have failed, but continuing..."
                }
              
              echo "âœ“ Completed apply (API Gateway skipped as it already exists)"
            else
              echo "âœ— Terraform apply failed with error (not related to API Gateway)"
              echo "Error output:"
              cat /tmp/terraform-apply.log
              exit $APPLY_EXIT_CODE
            fi
          fi

      - name: Save Terraform Outputs
        working-directory: infrastructure/serverless
        run: terraform output -json > terraform-outputs.json

      - name: Upload Terraform artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: infrastructure/serverless/
          retention-days: 1
  build-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-infra
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Terraform artifacts
        uses: actions/download-artifact@v4
        with:
          name: terraform-state
          path: infrastructure/serverless/

      - name: Install Yandex Cloud CLI
        run: |
          curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH="$PATH:$HOME/yandex-cloud/bin"
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
          yc --version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Extract Terraform outputs
        working-directory: infrastructure/serverless
        env:
          YC_TOKEN: ${{ secrets.YC_IAM_TOKEN }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
        run: |
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº yc CLI Ð² PATH (ÐµÑÐ»Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð² Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ¼ ÑˆÐ°Ð³Ðµ)
          export PATH="$PATH:$HOME/yandex-cloud/bin"
          
          export STATIC_BUCKET_NAME=$(jq -r '.static_bucket_name.value' terraform-outputs.json)
          export AWS_ACCESS_KEY_ID=$(jq -r '.static_site_access_key.value' terraform-outputs.json)
          export AWS_SECRET_ACCESS_KEY=$(jq -r '.static_site_secret_key.value' terraform-outputs.json)
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ API Gateway endpoint (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ null ÐµÑÐ»Ð¸ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½)
          API_GATEWAY_ENDPOINT_RAW=$(jq -r '.api_gateway_endpoint.value' terraform-outputs.json)
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð½Ðµ null Ð¸ Ð½Ðµ Ð¿ÑƒÑÑ‚Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ°
          if [ "$API_GATEWAY_ENDPOINT_RAW" != "null" ] && [ -n "$API_GATEWAY_ENDPOINT_RAW" ]; then
            API_GATEWAY_ENDPOINT="$API_GATEWAY_ENDPOINT_RAW"
            echo "âœ“ API Gateway endpoint from Terraform: $API_GATEWAY_ENDPOINT"
          else
            echo "â„¹ï¸  API Gateway endpoint not in Terraform output (may already exist)"
            echo "Attempting to get API Gateway endpoint via yc CLI..."
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ yc CLI ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
            if ! command -v yc &> /dev/null; then
              curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash >/dev/null 2>&1
              export PATH="$PATH:$HOME/yandex-cloud/bin"
            fi
            
            # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
            export YC_TOKEN="$YC_TOKEN"
            yc config set token "$YC_TOKEN" || true
            yc config set folder-id "$YC_FOLDER_ID" || true
            yc config set cloud-id "$YC_CLOUD_ID" || true
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
            if ! yc iam service-account list --format json >/dev/null 2>&1; then
              echo "âš ï¸  yc authentication failed, trying alternative method..."
              # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
              export YC_TOKEN="$YC_TOKEN"
            fi
            
            # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ endpoint ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ API Gateway
            API_GATEWAY_NAME="devops-portfolio-serverless-api"
            echo "Looking for API Gateway: $API_GATEWAY_NAME"
            
            # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· get Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸
            API_GATEWAY_DOMAIN=$(yc serverless api-gateway get --name "$API_GATEWAY_NAME" --format json 2>&1 | jq -r '.domain // empty' || echo "")
            
            # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· list Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ
            if [ -z "$API_GATEWAY_DOMAIN" ] || [ "$API_GATEWAY_DOMAIN" = "null" ]; then
              echo "Trying to list all API Gateways..."
              API_GATEWAY_DOMAIN=$(yc serverless api-gateway list --format json 2>&1 | jq -r ".[] | select(.name == \"$API_GATEWAY_NAME\") | .domain // empty" || echo "")
            fi
            
            if [ -n "$API_GATEWAY_DOMAIN" ] && [ "$API_GATEWAY_DOMAIN" != "null" ] && [ "$API_GATEWAY_DOMAIN" != "" ]; then
              API_GATEWAY_ENDPOINT="https://${API_GATEWAY_DOMAIN}"
              echo "âœ“ Found existing API Gateway endpoint: $API_GATEWAY_ENDPOINT"
            else
              echo "âœ— Could not get API Gateway endpoint"
              echo "  API Gateway may not exist or yc authentication failed"
              echo "  Attempting to use backend URL directly..."
              # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ backend URL Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
              BACKEND_URL=$(jq -r '.backend_url.value' terraform-outputs.json)
              if [ -n "$BACKEND_URL" ] && [ "$BACKEND_URL" != "null" ]; then
                API_GATEWAY_ENDPOINT="$BACKEND_URL"
                echo "âš ï¸  Using backend URL as fallback: $API_GATEWAY_ENDPOINT"
              else
                echo "âœ— No API Gateway endpoint available and no backend URL found"
                exit 1
              fi
            fi
          fi
          
          echo "API_GATEWAY_ENDPOINT=${API_GATEWAY_ENDPOINT}" >> $GITHUB_ENV
          echo "STATIC_BUCKET_NAME=${STATIC_BUCKET_NAME}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" >> $GITHUB_ENV
          echo "API_GATEWAY_ENDPOINT=${API_GATEWAY_ENDPOINT}"
          echo "STATIC_BUCKET_NAME=${STATIC_BUCKET_NAME}"

      - name: Build and deploy frontend
        working-directory: CI
        env:
          API_GATEWAY_ENDPOINT: ${{ env.API_GATEWAY_ENDPOINT }}
          STATIC_BUCKET_NAME: ${{ env.STATIC_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ env.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ env.AWS_SECRET_ACCESS_KEY }}
        run: |
          chmod +x build_frontend.sh
          ./build_frontend.sh

