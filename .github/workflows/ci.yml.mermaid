flowchart TB

    subgraph Triggers["Триггеры"]
        PushEvent[Push → main]
        Pull_RequestEvent[Pull Request → main]
    end

    subgraph Env["Переменные окружения"]
        IMAGE_TAG[IMAGE_TAG]
    end

    subgraph Job1["Сборка и публикация backend"]
        direction TB
        A1[Получение кода]
        A2[Настройка Docker Buildx]
        A3[Проверка секретов]
        A4[Авторизация в YCR]
        A5[Сборка и публикация backend-образа]
        A1 --> A2 --> A3 --> A4 --> A5
    end

    subgraph Job2["Развертывание инфраструктуры"]
        direction TB
        B1[Получение кода]
        B2[Установка Terraform]
        B3[Проверка существования API Gateway]
        B4[Создание terraform.tfvars]
        B5[Инициализация Terraform]
        B6[Удаление существующих сервисных аккаунтов]
        B7[Применение Terraform]
        B8[Сохранение Terraform outputs]
        B9[Загрузка артефактов Terraform]
        B1 --> B2 --> B3 --> B4 --> B5 --> B6 --> B7 --> B8 --> B9
    end

    subgraph Job3["Сборка и деплой фронтенда"]
        direction TB
        C1[Получение кода]
        C2[Загрузка артефактов Terraform]
        C3[Установка Yandex Cloud CLI]
        C4[Настройка Node.js]
        C5[Извлечение Terraform outputs]
        C6[Сборка и деплой фронтенда]
        C1 --> C2 --> C3 --> C4 --> C5 --> C6
    end

    Triggers --> Job1
    Triggers --> Job2
    Job2 --> Job3
    Env --> Job1
    Env --> Job2
    Env --> Job3

    style Triggers fill:#e3f2fd
    style Env fill:#f3e5f5
    style Job1 fill:#fff3e0
    style Job2 fill:#fff3e0
    style Job3 fill:#fff3e0
    style A5 fill:#c8e6c9
    style B9 fill:#c8e6c9
    style C6 fill:#c8e6c9
