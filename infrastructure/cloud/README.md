# Terraform (облачная инфраструктура, Yandex Cloud)

Этот каталог предназначен для ресурсов, автоматизирующих развёртывание облачной инфраструктуры проекта в Яндекс.Облаке с помощью Terraform.

## Важно о секретных переменных
- Все чувствительные данные (токены, cloud_id, folder_id, zone) хранятся только в отдельном файле `terraform.tfvars`.
- Рабочий файл `terraform.tfvars` ВСЕГДА должен быть в .gitignore (не попадёт в git, см. правила в проекте).
- В репозитории публикуется только шаблон: `terraform.tfvars.example`. Перед работой скопируйте его и заполните:
  ```bash
  cp terraform.tfvars.example terraform.tfvars
  # Далее отредактируйте terraform.tfvars под свои значения
  ```

## Описание сети (VPC, subnet, security group)

- **VPC (виртуальная облачная сеть)** позволяет изолировать и структурировать ресурсы в облаке, нужна для работы всего остального.
- **Подсеть (subnet)** определяет, где именно (в какой зоне, с каким адресным пространством) появляются ресурсы, и позволяет задавать доступ в Интернет.
- **Security group** — облачный firewall, управляет доступом к портам сервисов (например, разрешаем HTTP/HTTPS/SSH из Интернета, остальное закрыто).
- В облачных сценариях нельзя создать ВМ/кластер без указания VPC/subnet, а грамотно организованная security group — основа будущей безопасности.
- В проекте используется структура: одна VPC, одна публичная подсеть (можно расширять под high availability), security group с открытыми 22, 80, 443 портами (минимальный набор для администрирования и Web).

Пример кода — см. `main.tf`.

## Общие цели
- Создание облачного окружения «инфраструктура как код» (IaC)
- Развёртывание сетей, кластеров, машин и сервисов в облаке повторяемым способом

## Используемые источники
- [Разворачиваем без боли Terraform в Яндекс облаке (Habr)](https://habr.com/ru/companies/otus/articles/957982/)

---

## Первый этап — подключение облачного провайдера Terraform (Yandex Cloud)

1. Установите Terraform
2. Добавьте в файл `~/.terraformrc` mirror Яндекс (см. README локального варианта):
   ```
   provider_installation {
     network_mirror {
       url = "https://terraform-mirror.yandexcloud.net/"
       include = ["registry.terraform.io/*/*"]
     }
     direct {
       exclude = ["registry.terraform.io/*/*"]
     }
   }
   ```
3. Пропишите провайдер в `main.tf` (пример ниже)

---

## Пример provider блока для Yandex Cloud
```hcl
terraform {
  required_providers {
    yandex = {
      source  = "yandex-cloud/yandex"
      version = ">= 0.89"  # актуальная версия на момент добавления
    }
  }
}

provider "yandex" {
  token     = var.yc_token
  cloud_id  = var.yc_cloud_id
  folder_id = var.yc_folder_id
  zone      = var.yc_zone
}
```

---

## Managed Kubernetes Cluster (Yandex Cloud)

- После развёртывания VPC и подсети, с помощью Terraform создаётся облачный управляемый Kubernetes-кластер (Yandex Managed Service for Kubernetes).
- Вместе с кластером создаётся группа рабочих узлов (node group), которая может масштабироваться как по числу машин, так и по их параметрам (размер памяти, CPU, диск).
- Все параметры кластера (ID сервисного аккаунта, платформа, размер, количество узлов и др.) вынесены в переменные для гибкости.
- Для тестовых и MVP-задач рекомендовано использовать 1-2 маленьких ноды с preemptible-VM (экономно и подходит для разработки/обучения).
- Правильная структура позволяет позже безболезненно увеличить кластер или повысить отказоустойчивость.
- Сервисный аккаунт обязателен — он выдается при создании кластера и управляет всеми действиями узлов кластера и сервисов.

**В результате получаем:**
- Готовый для деплоя кластер Kubernetes в выбранной зоне Яндекс.Облака,
- Рабочий пул узлов под приложеня (бэкенд, фронтенд, БД) — всё будет развернуто через Helm или kubectl,
- Структуру, которая готова к масштабированию и эксплуатации по всем best practices DevOps.

**Важно!** Полные параметры и инструкции см. в примерах: `main.tf`, `variables.tf`, `terraform.tfvars.example`.

---

> **Важно:** Не забудьте задокументировать переменные (`variables.tf`) и сохранить `README.md` всегда в актуальном виде!
